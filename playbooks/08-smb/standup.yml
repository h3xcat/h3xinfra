---
- import_playbook: ../99-utils/kube-connect.yml

- name: Deploy SMB CSI Driver via Helm
  hosts: k8s
  gather_facts: false

  tasks:
  - name: Add SMB CSI Driver Helm repository
    kubernetes.core.helm_repository:
      name: csi-driver-smb
      repo_url: https://raw.githubusercontent.com/kubernetes-csi/csi-driver-smb/master/charts
      state: present
      force_update: true

  - name: Deploy SMB CSI Driver via Helm
    kubernetes.core.helm:
      name: "{{ smb.release_name_prefix }}-main"
      chart_ref: "csi-driver-smb/csi-driver-smb"
      chart_version: "{{ smb.chart_version }}"
      namespace: "{{ smb.namespace }}"
      create_namespace: false
      values:
        # Linux-specific configuration
        linux:
          enabled: true
          kubelet: "/var/lib/kubelet"
          resources:
            smb:
              limits:
                memory: "200Mi"
                cpu: "100m"
              requests:
                memory: "20Mi"
                cpu: "10m"
        
        # Windows disabled for this environment
        windows:
          enabled: false
        
        # Controller configuration
        controller:
          runOnControlPlane: true
          replicas: 1
          resources:
            smb:
              limits:
                memory: "200Mi"
                cpu: "100m"
              requests:
                memory: "20Mi" 
                cpu: "10m"
          
        # Driver configuration
        driver:
          name: "smb.csi.k8s.io"
      wait: true
      timeout: "300s"
