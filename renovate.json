{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended",
    ":dependencyDashboard",
    ":semanticCommits",
    ":separateMajorReleases",
    "docker:enableMajor",
    "helpers:pinGitHubActionDigests"
  ],
  "prConcurrentLimit": 5,
  "prHourlyLimit": 2,
  "timezone": "America/Los_Angeles",
  "labels": ["dependencies"],
  "commitMessagePrefix": "chore(deps):",
  "rangeStrategy": "bump",
  "minimumReleaseAge": "3 days",
  "vulnerabilityAlerts": {
    "labels": ["security"],
    "automerge": true
  },
  "packageRules": [
    {
      "description": "Group all Helm chart updates together",
      "matchDatasources": ["helm"],
      "groupName": "Helm charts",
      "schedule": ["before 10am on monday"]
    },
    {
      "description": "Group all Docker image updates together",
      "matchDatasources": ["docker"],
      "groupName": "Docker images",
      "schedule": ["before 10am on monday"]
    },
    {
      "description": "Automerge patch updates for non-major dependencies",
      "matchUpdateTypes": ["patch", "pin", "digest"],
      "automerge": true,
      "automergeType": "pr",
      "platformAutomerge": true
    },
    {
      "description": "Group Kubernetes-related updates",
      "matchPackagePatterns": ["^kubernetes", "^k8s", "kubectl", "^k3s"],
      "groupName": "Kubernetes",
      "schedule": ["before 10am on monday"]
    },
    {
      "description": "Group Cilium updates",
      "matchPackagePatterns": ["^cilium"],
      "groupName": "Cilium",
      "schedule": ["before 10am on monday"]
    },
    {
      "description": "Group Ansible collection updates",
      "matchDatasources": ["galaxy-collection"],
      "groupName": "Ansible collections",
      "schedule": ["before 10am on monday"]
    }
  ],
  "customManagers": [
    {
      "customType": "regex",
      "description": "Update Docker images in Helm values files (image.repository + image.tag pattern)",
      "fileMatch": [
        "(^|/)playbooks/.+/charts/.+/values\\.ya?ml$",
        "(^|/).*-values\\.ya?ml$"
      ],
      "matchStrings": [
        "repository:\\s*[\"']?(?<depName>[^\\s\"']+)[\"']?\\s+tag:\\s*[\"']?(?<currentValue>[^\\s\"']+)[\"']?"
      ],
      "datasourceTemplate": "docker"
    },
    {
      "customType": "regex",
      "description": "Update Docker images in Helm values files (image: format)",
      "fileMatch": [
        "(^|/)playbooks/.+/charts/.+/values\\.ya?ml$",
        "(^|/).*-values\\.ya?ml$"
      ],
      "matchStrings": [
        "image:\\s*[\"']?(?<depName>[^:\"'\\s]+):(?<currentValue>[^\\s\"']+)[\"']?"
      ],
      "datasourceTemplate": "docker"
    },
    {
      "customType": "regex",
      "description": "Update kubectl version in Dockerfile",
      "fileMatch": ["(^|/)\\.devcontainer/Dockerfile$"],
      "matchStrings": [
        "curl -LO \"https://dl\\.k8s\\.io/release/v(?<currentValue>[^/]+)/bin/linux/amd64/kubectl\""
      ],
      "depNameTemplate": "kubernetes/kubernetes",
      "datasourceTemplate": "github-releases",
      "extractVersionTemplate": "^v(?<version>.+)$"
    },
    {
      "customType": "regex",
      "description": "Update Helm in Dockerfile",
      "fileMatch": ["(^|/)\\.devcontainer/Dockerfile$"],
      "matchStrings": [
        "curl https://raw\\.githubusercontent\\.com/helm/helm/(?<currentValue>v[^/]+)/scripts/get-helm-3"
      ],
      "depNameTemplate": "helm/helm",
      "datasourceTemplate": "github-releases"
    },
    {
      "customType": "regex",
      "description": "Update base devcontainer image",
      "fileMatch": ["(^|/)\\.devcontainer/Dockerfile$"],
      "matchStrings": [
        "ARG BASE_IMAGE_NAME=(?<depName>[^\\n]+)\\nARG BASE_IMAGE_TAG=(?<currentValue>[^\\n]+)"
      ],
      "datasourceTemplate": "docker"
    },
    {
      "customType": "regex",
      "description": "Update Helm chart versions in standup.yml (kubernetes.core.helm pattern)",
      "fileMatch": ["(^|/)playbooks/.+/standup.*\\.ya?ml$"],
      "matchStrings": [
        "chart_repo_url:\\s*[\"']?(?<registryUrl>https?://[^\\s\"']+)[\"']?[\\s\\S]*?chart_ref:\\s*[\"']?(?<depName>[^\\s\"'/]+)[\"']?[\\s\\S]*?chart_version:\\s*[\"']?(?<currentValue>[^\\s\"']+)[\"']?"
      ],
      "datasourceTemplate": "helm"
    }
  ],
  "hostRules": [
    {
      "description": "Increase timeout for slow Helm registries",
      "matchHost": "helm.cilium.io",
      "timeout": 60000
    },
    {
      "description": "Increase timeout for GitHub Container Registry",
      "matchHost": "ghcr.io",
      "timeout": 30000
    }
  ]
}
